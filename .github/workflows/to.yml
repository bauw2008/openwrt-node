name: Test Commit and Push with PAT

on:
  workflow_dispatch:

jobs:
  test-push:
    runs-on: ubuntu-latest
    env:
      BRANCH: main
      GH_TOKEN: ${{ secrets.GH_PAT }}   # ä½ çš„ PAT secret åç§°

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Show git remote before change
        run: git remote -v

      - name: Test commit and push with PAT
        run: |
          set -euo pipefail
          echo "ğŸ“¦ Starting test commit and push..."

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "ğŸ“ Creating test file..."
          echo "test content $(date)" > test.txt
          ls -l test.txt

          echo "ğŸ”„ Fetching latest branch ${BRANCH}..."
          git fetch origin "${BRANCH}"
          git checkout "${BRANCH}"

          echo "â• Adding test.txt to staging..."
          git add test.txt

          if git diff --cached --quiet; then
            echo "â„¹ï¸ No changes to commit."
          else
            echo "âœ… Changes detected. Committing..."
            git commit -m "Test commit: add test.txt from GitHub Actions"
          fi

          echo "ğŸ”— Setting remote URL with PAT..."
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/bauw2008/openwrt-node.git"

          echo "ğŸ“¢ Remote URLs after update:"
          git remote -v

          echo "ğŸš€ Pushing to ${BRANCH}..."
          git push origin "${BRANCH}"

          echo "âœ… Push completed successfully!"

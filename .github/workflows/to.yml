name: Test Commit and Push

on:
  workflow_dispatch:

jobs:
  commit-and-push:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_PAT }}
      BRANCH: main
      NODE_VERSION: 18.16.0
      BUILD_ARCH: amd64
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        # 拉取完整历史
          persist-credentials: false  # 不使用默认的 GITHUB_TOKEN 凭证

      - name: Prepare and commit test file
        run: |
          set -euo pipefail
          echo "Starting test commit and push..."
          echo "Creating test file..."
          echo "This is a test file created by GitHub Actions." > test.txt
          ls -l test.txt

          echo "Fetching latest branch ${BRANCH}..."
          git fetch origin "${BRANCH}"
          git checkout "${BRANCH}"

          echo "Adding test.txt to staging..."
          git add test.txt

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            echo "Changes detected, committing..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git commit -m "Test commit: add test.txt from GitHub Actions"

            echo "Setting remote URL with PAT..."
            git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git"
            
            echo "Remote URLs after update:"
            git remote -v
            
            echo "Pushing to ${BRANCH}..."
            git push origin "${BRANCH}"
            echo "Push succeeded."
          fi

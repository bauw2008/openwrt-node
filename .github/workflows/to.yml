- name: Commit and Push Test File to Repository Directory
  env:
    BRANCH: ${{ github.ref_name }}
    GH_TOKEN: ${{ secrets.GH_PAT }}
  run: |
    set -euo pipefail
    echo "ğŸ“¦ Starting test commit and push..."

    (
      set -e

      # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
      echo "ğŸ”§ Configuring git user..."
      git config user.name "github-actions[bot]"
      git config user.email "github-actions[bot]@users.noreply.github.com"

      # åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
      TEST_FILE="test.txt"
      echo "This is a test file created by GitHub Actions at $(date)" > "${TEST_FILE}"
      echo "ğŸ“ Created test file: ${TEST_FILE}"
      ls -l "${TEST_FILE}"

      # ç¡®ä¿åˆ†æ”¯åŒæ­¥æœ€æ–°
      echo "ğŸ”„ Fetching latest branch ${BRANCH}..."
      git fetch origin "${BRANCH}"
      git checkout "${BRANCH}"

      # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
      echo "â• Adding ${TEST_FILE} to staging..."
      git add "${TEST_FILE}"

      # æ£€æŸ¥æ˜¯å¦æœ‰æ”¹åŠ¨
      if git diff --cached --quiet; then
        echo "â„¹ï¸ No changes to commit."
      else
        echo "âœ… Changes detected. Committing..."
        git commit -m "Test commit: add ${TEST_FILE} from GitHub Actions"

        # é…ç½® remote URL ä½¿ç”¨ PAT
        echo "ğŸ”— Setting remote URL with PAT..."
        git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/bauw2008/openwrt-node.git"

        # æ‰§è¡Œ push
        echo "ğŸš€ Pushing to ${BRANCH}..."
        git push origin "${BRANCH}"
        echo "ğŸ‰ Push completed successfully!"
      fi
    ) || echo "âš ï¸ Git push failed, but continuing build anyway."

    echo "âœ… Script finished."

name: Test Commit and Push

on:
  workflow_dispatch:

jobs:
  test-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Commit and Push Test File to Repository Directory
        env:
          BRANCH: ${{ github.ref_name }}
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          set -euo pipefail
          echo "ğŸ“¦ Starting test commit and push..."

          (
            set -e

            echo "ğŸ”§ Configuring git user..."
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            TEST_FILE="test.txt"
            echo "This is a test file created by GitHub Actions at $(date)" > "${TEST_FILE}"
            echo "ğŸ“ Created test file: ${TEST_FILE}"
            ls -l "${TEST_FILE}"

            echo "ğŸ”„ Fetching latest branch ${BRANCH}..."
            git fetch origin "${BRANCH}"
            git checkout "${BRANCH}"

            echo "â• Adding ${TEST_FILE} to staging..."
            git add "${TEST_FILE}"

            if git diff --cached --quiet; then
              echo "â„¹ï¸ No changes to commit."
            else
              echo "âœ… Changes detected. Committing..."
              git commit -m "Test commit: add ${TEST_FILE} from GitHub Actions"

              echo "ğŸ”— Setting remote URL with PAT..."
              git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/bauw2008/openwrt-node.git"

              echo "ğŸš€ Pushing to ${BRANCH}..."
              git push origin "${BRANCH}"
              echo "ğŸ‰ Push completed successfully!"
            fi
          ) || echo "âš ï¸ Git push failed, but continuing build anyway."

          echo "âœ… Script finished."

name: Test Commit and Push with PAT

on:
  workflow_dispatch:

jobs:
  test-push:
    runs-on: ubuntu-latest
    env:
      BRANCH: main
      GH_TOKEN: ${{ secrets.GH_PAT }}   # 你的 PAT secret 名称

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Show git remote before change
        run: git remote -v

      - name: Test commit and push with PAT
        run: |
          set -euo pipefail
          echo "📦 Starting test commit and push..."

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          echo "📝 Creating test file..."
          echo "test content $(date)" > test.txt
          ls -l test.txt

          echo "🔄 Fetching latest branch ${BRANCH}..."
          git fetch origin "${BRANCH}"
          git checkout "${BRANCH}"

          echo "➕ Adding test.txt to staging..."
          git add test.txt

          if git diff --cached --quiet; then
            echo "ℹ️ No changes to commit."
          else
            echo "✅ Changes detected. Committing..."
            git commit -m "Test commit: add test.txt from GitHub Actions"
          fi

          echo "🔗 Setting remote URL with PAT..."
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/bauw2008/openwrt-node.git"

          echo "📢 Remote URLs after update:"
          git remote -v

          echo "🚀 Pushing to ${BRANCH}..."
          git push origin "${BRANCH}"

          echo "✅ Push completed successfully!"
